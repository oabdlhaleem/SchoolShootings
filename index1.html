<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Mass Shootings</title>

  <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/cerulean/bootstrap.min.css" rel="stylesheet" integrity="sha384-C++cugH8+Uf86JbNOnQoBweHHAe/wVKN/mb0lTybu/NZ9sEYbd+BbbYtNpWYAsNP" crossorigin="anonymous">
  <style>
    #map {
      width: 100%;
      height: calc(40vh);
    }

    #about {
      max-height: calc(80vh);
      overflow-y: scroll;
    }

    #ui {
      position: absolute;
      right: 1em;
      top: 4em;
    }

    #button {
      position: absolute;
      right: 1em;
      top: 1em;
    }

    .state {
      fill: maroon;
      stroke: #4C0707;
      stroke-width: .7;
    }

    .locations {
      fill: #FFA500;
      stroke: white;
      stroke-width: .3;
      opacity: 1;
    }

    .locations:hover {
      stroke-width: 2;
    }

    .casualties {
      fill: #FFA500;
      stroke: white;
      stroke-width: .3;
      opacity: 1;
    }

    .casualties:hover {
      stroke-width: 2;
    }

    /* slider ui */
    .slider {
      -webkit-appearance: none;
      width: 25%;
      height: 15px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      cursor: pointer;
      /* -webkit-transition: .2s;
      transition: opacity .2s; */
    }

    .slider:hover {
      opacity: 1;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #FFA500;
      cursor: pointer;
    }

    /* .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #FFA500;
      cursor: pointer;
    } */


    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) {}

    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {
      #map {
        height: calc(60vh);
      }
    }

    /* Large devices (desktops, 992px and up) */
    @media (min-width: 992px) {

      #map {
        height: calc(80vh);
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <header class="row py-2 bg-warning text-white">
      <div class="col mx-2">
        <h1 class="h1">Generation Lockdown: A Map of Mass Shootings</h1>
      </div>
    </header>

    <section class="row bg-secondary ">

      <aside id="about" class="col-12 col-md-4 col-lg-3 text-dark py-2">
        <section>
          <h2 class="h2 text-dark">This is a map</h2>
          <p>Over the last generation we've seen mass shootings become a thing. Within the span of most of our memories they have gone from an unspeakable tragedy to a well discussed (but still tragic) feature of our society.</p>

          <hr class="my-4">

          <div id="locationType">
            <h6 class="h6 text-dark">Location Type</h6>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="Airport" checked="">
              <label class="custom-control-label" for="Airport">Airport</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="College" checked="">
              <label class="custom-control-label" for="College">College</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="Military" checked="">
              <label class="custom-control-label" for="Military">Military</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="Religious" checked="">
              <label class="custom-control-label" for="Religious">Religious</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="School" checked="">
              <label class="custom-control-label" for="School">School</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="Workplace" checked="">
              <label class="custom-control-label" for="Workplace">Workplace</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="Other" checked="">
              <label class="custom-control-label" for="Other">Other</label>
            </div>
          </div>

        </section>
      </aside>

      <div class="col-12 col-md-8 col-lg-9 px-0">
        <div id="map" class="bg-light position-relative">

          <div id="ui" class="dropdown">
            <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              All Attacks
            </a>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink"></div>
          </div>

          <!-- ui slider -->
          <div class='slidecontainer'>
            <input type='range' min="1" max="8" value="1" step="1" class="slider" id='slider'>
          </div>

          <!-- ui grade -->
          <div id='grade' class='bg-white round px12 py12 relative'>
            <h3 class='grade-lable txt-bold'></h3>
          </div>

          <button id='button' type="button" class="btn btn-warning">Show by Casualties</button>

        </div>
      </div>


    </section>
    <footer class="row bg-warning text-white py-3">
      <div class="col mx-2">
        <ul class="list-unstyled">
          <li>Map authored by <a href="https://oabdlhaleem.github.io/">Osama Abdl-Haleem</a></li>
          <li>data sourced from
            <a href="https://www.census.gov/geo/maps-data/data/tiger-cart-boundary.html">Cartographic Boundary Files</a>
            and the
            <a href="https://www.epa.gov/air-emissions-inventories/emissions-inventory-system-eis-gateway">EPA Air
              Emissions Inventories</a></li>
        </ul>
      </div>
    </footer>
  </div> <!-- end .container-fluid -->

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>

  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    // JavaScript

    // asynchronous calls to data files
    const statesJson = d3.json('data/us-states.json');
    const shootingsCSV = d3.csv('data/usMassShootings.csv');

    // use promise to call all data files, then send data to callback
    Promise.all([statesJson, shootingsCSV])
      .then(drawMap)
      .catch(error => {
        console.log(error)
      });

    // function called when Promise above is complete
    function drawMap(data) {

      // data is array of our two datasets
      const statesData = data[0];
      const shootingsData = data[1];

      // select the HTML element that will hold our map
      const mapContainer = d3.select('#map')

      // determine width and height of map from container
      const width = mapContainer.node().offsetWidth - 60;
      const height = mapContainer.node().offsetHeight - 60;

      const svg = mapContainer
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .classed('position-absolute', true) // add bootstrap class
        .style('top', 40)
        .style('left', 30);

      const geojson = topojson.feature(statesData, {
        type: 'GeometryCollection',
        geometries: statesData.objects.cb_2016_us_state_20m.geometries
      });

      const projection = d3.geoAlbersUsa()
        .fitSize([width, height], geojson);

      const path = d3.geoPath()
        .projection(projection);

      // add states to svg
      const states = svg.append('g') // append a new g element to svg
        .selectAll('path') //select all unmade paths
        .data(geojson.features) //import geojson feature data
        .join('path') // creat path elements and join the data
        .attr('d', path) // make new d attribute for sbg paths
        .attr('class', 'state'); // give each path an attribute name of state for css styling

      // add and style circle
      const locations = svg.append('g') // append new g element
        .selectAll('circle') // select all the circles
        .data(shootingsData.sort(function(a, b) {
          return b.casualties - a.casualties; // place the large ones on the bottom
        })) // use the facility CSV data
        .join('circle') // join that data to circle elements
        .attr('cx', d => { // feed the long/lat to the projection generator
          d.position = projection([d.long, d.lat]); // create a new data attribute
          return d.position[0]; // position the x
        })
        .attr('cy', d => {
          return d.position[1]; // position the y
        })
        .attr('r', 5)
        .attr('class', 'locations') // give each circle a class name

      // Create  div for the tooltip and hide with opacity
      const tooltip = d3.select('.container-fluid').append('div')
        .attr('class', 'my-tooltip bg-info text-white py-1 px-2 rounded position-absolute invisible');

      // when mouse moves over the mapContainer
      mapContainer
        .on('mousemove', event => {
          // update the position of the tooltip
          tooltip.style('left', (d3.event.pageX + 10) + 'px')
            .style('top', (d3.event.pageY - 30) + 'px');
        });

      // applies event listeners to our polygons for user interaction
      locations.on('mouseover', (d, i, nodes) => { // when mousing over an element
          d3.select(nodes[i]).classed('hover', true); // select it, add a class name
          tooltip.classed('invisible', false).html("<b>" + d.case+"</b>" + "<br>" + d.date + "<br>Killed: " + d.killed + "<br>Injured: " + d.injured + "<br><b>Total Casualties:</b> " + d.casualties) // make tooltip visible and update info
        })
        .on('mouseout', (d, i, nodes) => { // when mousing out of an element
          d3.select(nodes[i]).classed('hover', false) // remove the class from the polygon
          tooltip.classed('invisible', true) // hide the element
        });

      changeSymbology(locations);

      //  filterLocations(shootingsData, locations);

      filterLocationType(locations);
    } // end drawMap

    function changeSymbology(locations) {
      d3.select('#button').on('click', changeTheme);

      // define radius generator
      const radius = d3.scaleSqrt().domain([3, 604]).range([3, 150]);

      function changeTheme() {
        if (d3.select('#button').html() === 'Show by Casualties') {
          d3.select('#button').html('Show by Location');
          locations.attr('r', d => {
              return radius(d.casualties); // define the radius
            })
            .attr('class', 'casualties') // give each circle a class name
            .style('opacity', .7)
        } else {
          d3.select('#button').html('Show by Casualties');
          locations.attr('r', 5)
            .attr('class', 'locations') // give each circle a class name
            .style('opacity', 1)
        }
      }
    }

    // function filterLocations(shootingsData, locations) {
    //   // array to hold select options
    //   var uniqueTypes = [];
    //
    //   // loop through all features and push unique types to array
    //   shootingsData.forEach(function(locations) {
    //     if (!uniqueTypes.includes(locations.locationType)) {
    //       uniqueTypes.push(locations.locationType);
    //     }
    //   });
    //
    //   // sort strings alphabetically
    //   uniqueTypes.sort();
    //
    //   // add an all facilities to the beginning
    //   uniqueTypes.unshift('All Attacks');
    //
    //   // select all the options (that don't exist yet)
    //   d3.select('#ui .dropdown-menu').selectAll('a')
    //     .data(uniqueTypes) // use array as data
    //     .join('a') // append a new option element for each data item
    //     .text(d => {
    //       return d // use the item as text
    //     })
    //     .attr('value', d => {
    //       return d // use the time as value attribute
    //     })
    //     .attr('href', '#')
    //     .classed('dropdown-item', true)
    //     .on('click', onchange); // when the user clicks call onchange function
    //
    //   function onchange() {
    //     // get the currently selected value
    //     let val = d3.select(this).attr('value');
    //
    //     // change the display property for each circle
    //     locations.style('display', d => {
    //       if (val === 'All Attacks') return 'inline';
    //       if (d.locationType != val) return 'none';
    //     });
    //
    //     d3.select('#ui > a').html(val); // update the UI with current val
    //   }
    // } // end filterLocations function

    function filterLocationType(locations) {

      // Initialize update() at the beginning
      update()

      function update() {

        // For each checkbox:
        d3.selectAll(".custom-control-input").each(function(d) {
          var checkBox = d3.select(this);
          var checkBoxName = checkBox.property("id");

          if (checkBox.property("checked")) {
            locations.style('opacity', function(d) {
              // apply a conditional test
              if (d.locationType === checkBoxName) {
                return 1; // return attribute value for dots
              }
            })
          } else {
            locations.style('opacity', function(d) {
              // apply a conditional test
              if (d.locationType === checkBoxName) {
                return 0; // return attribute value
              }
            })
          }
        })
      }

      // When a button changes, run the update function
      d3.selectAll(".custom-control-input").on("change", update);

    } // end filterLocationType()
  </script>
</body>

</html>
